{% extends 'base.html' %}

{% block title %}Gmail Emails - Job Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Recent Emails</h1>
    <div class="d-flex gap-1">
        <button class="btn btn-primary" id="refresh-btn">Refresh Emails</button>
    </div>
</div>

{% if messages %}
<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Subject</th>
                <th>From</th>
                <th>Received</th>
            </tr>
        </thead>
        <tbody>
            {% for message in messages %}
            <tr>
                <td><strong>{{ message.subject|default:"(No subject)" }}</strong></td>
                <td>{{ message.sender }}</td>
                <td>{{ message.received_at|date:"M d, Y H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 3rem;">
    <p style="color: #7f8c8d; margin-bottom: 1rem;">No emails fetched yet.</p>
    <button class="btn btn-primary" id="fetch-btn">Fetch Emails Now</button>
</div>
{% endif %}

<script>
    async function fetchEmails() {
        const btn = document.getElementById('refresh-btn') || document.getElementById('fetch-btn');
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'Fetching...';
        }
        try {
            const response = await fetch("{% url 'gmail:fetch-emails' %}");
            const data = await response.json();
            if (data.error) {
                alert(data.error);
            } else {
                window.location.reload();
            }
        } catch (error) {
            console.error(error);
            alert('Failed to fetch emails');
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Refresh Emails';
            }
        }
    }

    const refreshBtn = document.getElementById('refresh-btn');
    const fetchBtn = document.getElementById('fetch-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', fetchEmails);
    if (fetchBtn) fetchBtn.addEventListener('click', fetchEmails);
</script>
{% endblock %}
